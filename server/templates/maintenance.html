{% extends "base.html" %}
{% block title %}Maintenance â€” LEAKCHECK Admin{% endblock %}
{% block content %}
<h1>Database Maintenance</h1>

<div class="cards mb-2">
    <div class="card">
        <div class="label">Database Size</div>
        <div class="value">{{ stats.db_size_mb }} MB</div>
    </div>
    <div class="card">
        <div class="label">Leak Records</div>
        <div class="value">{{ "{:,}".format(stats.total_records) }}</div>
    </div>
    <div class="card">
        <div class="label">Queries (24h)</div>
        <div class="value">{{ stats.queries_24h }}</div>
    </div>
    <div class="card">
        <div class="label">Last Update</div>
        <div class="value text-sm">{{ stats.last_update|epoch_to_date if stats.last_update else 'Never' }}</div>
    </div>
</div>

<h2>Actions</h2>
<div class="form-row mb-2">
    <form method="POST" action="{{ url_for('admin_web.maintenance_vacuum') }}" style="display:inline;">
        <button type="submit" class="btn btn-info" onclick="return confirm('Run VACUUM? This may take a while on large databases.')">VACUUM</button>
    </form>
    <form method="POST" action="{{ url_for('admin_web.maintenance_optimize') }}" style="display:inline;">
        <button type="submit" class="btn btn-success" onclick="return confirm('Run full optimization (purge old logs + ANALYZE + VACUUM)?')">Full Optimize</button>
    </form>
    <form method="POST" action="{{ url_for('admin_web.maintenance_rebuild_indexes') }}" style="display:inline;">
        <button type="submit" class="btn btn-primary" onclick="return confirm('Rebuild all indexes?')">Rebuild Indexes</button>
    </form>
</div>

<h2>Purge Old Logs</h2>
<form method="POST" action="{{ url_for('admin_web.maintenance_purge_logs') }}">
    <div class="form-row">
        <div class="form-group">
            <label>Older Than (days)</label>
            <input type="text" name="days" value="30" style="width:80px;">
        </div>
        <button type="submit" class="btn btn-danger" onclick="return confirm('Delete logs older than the specified days?')">Purge Logs</button>
    </div>
</form>

{% if table_sizes %}
<h2>Table Sizes</h2>
<table>
    <thead>
        <tr><th>Table / Index</th><th>Rows</th><th>Pages</th><th>Size</th></tr>
    </thead>
    <tbody>
        {% for t in table_sizes %}
        <tr>
            <td>{{ t.name }}</td>
            <td>{{ "{:,}".format(t.row_count) }}</td>
            <td>{{ "{:,}".format(t.page_count) }}</td>
            <td>{{ t.size_mb }} MB</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}
